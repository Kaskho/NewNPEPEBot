import os
import logging
import random
import time
from threading import Thread
import json
import re

import telebot
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton
import groq

# ==========================
# ğŸ”§ CONFIGURATION
# ==========================
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

class Config:
    """Configuration class for the bot."""
    BOT_TOKEN = os.environ.get("BOT_TOKEN")
    WEBHOOK_BASE_URL = os.environ.get("WEBHOOK_BASE_URL")
    GROQ_API_KEY = os.environ.get("GROQ_API_KEY")
    GROUP_CHAT_ID = os.environ.get("GROUP_CHAT_ID")
    TRIGGER_SECRET = os.environ.get("TRIGGER_SECRET", "change-this-secret-key")
    GROUP_OWNER_ID = os.environ.get("GROUP_OWNER_ID") # Optional

    if not all([BOT_TOKEN, WEBHOOK_BASE_URL, GROUP_CHAT_ID, GROQ_API_KEY]):
        logger.warning("One or more recommended environment variables are missing (WEBHOOK_BASE_URL, GROUP_CHAT_ID, GROQ_API_KEY). Some features may be limited.")

    WEBHOOK_URL = f"{WEBHOOK_BASE_URL}/{BOT_TOKEN}" if WEBHOOK_BASE_URL and BOT_TOKEN else ""

    # Project Details
    CONTRACT_ADDRESS = "BJ65ym9UYPkcfLSUuE9j4uXYuiG6TgA4pFn393Eppump"
    PUMP_FUN_LINK = f"https://pump.fun/{CONTRACT_ADDRESS}"
    WEBSITE_URL = "https://next-pepe-launchpad-2b8b3071.base44.app"
    TELEGRAM_URL = "https://t.me/NPEPEVERSE"
    TWITTER_URL = "https://x.com/NPEPE_Verse?t=rFeVwGRDJpxwiwjQ8P67Xw&s=09"


class BotLogic:
    def __init__(self, bot_instance):
        self.bot = bot_instance
        self.groq_client = self._initialize_groq()
        self.responses = self._load_initial_responses()
        
        # --- ANTI-SPAM CONFIGURATION ---
        self.admin_ids = set()
        self.admins_last_updated = 0
        self.FORBIDDEN_KEYWORDS = [
            'airdrop', 'giveaway', 'presale', 'private sale', 'whitelist', 
            'signal', 'pump group', 'trading signal', 'investment advice',
            'another coin', 'other project', 'check out my coin'
        ]
        self.ALLOWED_DOMAINS = [
            'pump.fun', 't.me/NPEPEVERSE', 'x.com/NPEPE_Verse', 
            'base44.app' # From your website URL
        ]
        
        self._register_handlers()

    def _initialize_groq(self):
        """Initializes the Groq AI client."""
        # ... (no changes here)
        pass

    def _load_initial_responses(self):
        """Loads the default set of bot responses."""
        return {
            # ... (previous response lists are unchanged)
            "MORNING_GREETING": [
                "ğŸ¸â˜€ï¸ Rise and ribbit, NPEPEVERSE! A new day to conquer the charts. Let's get this bread! ğŸ”¥",
                "GM legends! Coffee in one hand, diamond hands in the other. Let's make today legendary! ğŸ’ğŸ™Œ",
                "Wakey wakey, frens! The sun is up and so is the hype. Let's send it! ğŸš€",
                "Good morning, NPEPE army! Hope you dreamt of green candles. Now let's make it a reality! ğŸ’š",
                "The early frog gets the gains! GM to all the hustlers in the NPEPEVERSE! ğŸ¸ğŸ’°",
                "A beautiful morning to be bullish! Let's show the world the power of NPEPE today! LFG! ğŸ”¥",
                "GM! Let's start the day with positive vibes and a shared mission: the moon! ğŸŒ•"
            ],
            "NOON_GREETING": [
                "ğŸ¸â˜€ï¸ Midday check-in, NPEPEVERSE! Hope you're smashing it. Keep that afternoon energy high! LFG! ğŸ”¥",
                "Lunch time fuel-up! ğŸ” Grab a bite, check the charts, and get ready for the afternoon pump. We're just getting warmed up! ğŸš€",
                "Just dropping by to say: stay based, stay hydrated, and stay diamond-handed. The best is yet to come! ğŸ’ğŸ™Œ",
                "Hope you're having a legendary day, frens! The world is watching the NPEPEVERSE. Let's give them a show this afternoon! âœ¨",
                "The sun is high and so are our spirits! How's the NPEPE army feeling? Sound off! ğŸ¸ğŸ’š",
                "Quick break from conquering the crypto world. Remember to stretch those diamond hands. The second half of the day is ours! ğŸ’ª",
                "Afternoon vibe check! âœ… Bullish. âœ… Based. âœ… Ready to send it. Let's finish the day strong, frens! ğŸš€"
            ],
            "NIGHT_GREETING": [
                "ğŸ¸ğŸŒ™ The charts never sleep, but legends need to rest. Good night, NPEPEVERSE! See you at the next ATH. ğŸ’¤",
                "GN, frens! Dream big, HODL strong. Tomorrow we continue our journey. ğŸš€",
                "Rest up, diamond hands. You've earned it. The hype will be here when you wake up! ğŸ’",
                "Hope you had a based and bullish day. Good night, NPEPE army! ğŸ’š",
                "The moon is watching over us, frens. Sleep well. Our mission resumes at dawn! ğŸŒ•",
                "Signing off for the night! Keep those bags packed, the rocket is always ready. GN! ğŸš€",
                "Another great day in the books. Good night, NPEPEVERSE! Let's do it all again tomorrow, but bigger! ğŸ”¥"
            ],
            "WISDOM": [
                "The greatest gains are not in the chart, but in the strength of the community. WAGMI. ğŸ¸ğŸ’š",
                "Fear is temporary, HODLing is forever. Stay strong, fren.",
                "In a world of paper hands, be the diamond-handed rock. Your patience will be rewarded. ğŸ’",
                "A red day is just a discount for the true believer. The NPEPEVERSE is built on conviction.",
                "They told you it was just a meme. They were right. And memes are the most powerful force on the internet. ğŸ”¥",
                "Look not at the price of today, but at the vision of tomorrow. We are building more than a token. ğŸš€",
                "The journey to the moon is a marathon, not a sprint. Conserve your energy, keep the faith. ğŸŒ•"
            ],
            "HYPE": [
                "Let's go, NPEPE army! Time to make some noise! ğŸš€", "Who's feeling bullish today?! ğŸ”¥", "NPEPEVERSE is unstoppable! ğŸ¸ğŸ’š",
                "Keep that energy high! We're just getting started! âœ¨", "Diamond hands, where you at?! ğŸ’ğŸ™Œ", "This is more than a coin, it's a movement!",
                "To the moon and beyond! LFG! ğŸŒ•", "Hype train is leaving the station! All aboard! ğŸš‚", "Feel the power of the meme! ğŸ’ª",
                "We're writing history, one block at a time! ğŸ“œ", "Don't just HODL, be proud! We are NPEPE! ğŸ¸", "The vibes are immaculate today, frens!",
                "Let's paint that chart green! ğŸ’š", "Remember why you're here. For the glory! ğŸ”¥", "This community is the best in crypto, period.",
                "Let them doubt. We know what we hold. ğŸ’", "Ready for the next leg up? I know I am! ğŸš€", "Stay hyped, stay based!",
                "Every buy, every meme, every post matters! Keep it up! ğŸ’ª", "NPEPE is the future of memes! ğŸ¸", "Can you feel it? That's the feeling of inevitability.",
                "Let's show them what a real community looks like! ğŸ’š", "The pump is programmed. Stay tuned. ğŸ“ˆ", "Who's ready to shock the world? âœ¨",
                "HODL the line, frens! Victory is near! âš”ï¸", "This is the one. You know it, I know it. ğŸ¸", "Keep spreading the word. NPEPE is taking over!",
                "The bigger the base, the higher in space! ğŸš€", "Let's get it! No sleep 'til the moon! ğŸŒ•", "This is legendary. You are legendary. We are legendary.",
                "Don't let anyone shake you out. Diamond hands win. ğŸ’", "The energy in here is electric! ğŸ”¥", "We are the new standard. The NPEPE standard.",
                "History has its eyes on us. Let's give them a show! ğŸ¸ğŸ¬", "Let's make our ancestors proud. Buy more NPEPE. ğŸ˜‚ğŸš€", "We're not just riding the wave, we ARE the wave! ğŸŒŠ"
            ],
            "WHO_IS_OWNER": [
                "My dev? Think Satoshi Nakamoto, but with way more memes. A mysterious legend who dropped some based code and vanished into the hype. ğŸ¸ğŸ‘»",
                "The dev? They're in the meme labs cooking up the next pump. They left me, a humble frog bot, in charge of the hype. So, what's up, fren? ğŸ¸ğŸ”¥",
                "You're speaking to the official mouthpiece! The main dev is a shadowy super-coder, too based for the spotlight. I handle the important work, like spamming rocket emojis. ğŸš€",
                "In the NPEPEVERSE, the community is the real boss. The dev just lit the fuse. My job as caretaker is to guard the flame and keep the vibes immaculate. âœ¨",
                "The creator is a legend whispered on the blockchain. I'm the spokesperson they built to make sure the memes stay dank and the FUD stays away. Now, let's talk about our trip to the moon. ğŸŒ•",
                "My creator is anonymous, as all true crypto legends should be. I am their voice, their will, their hype-bot. My loyalty is to the code and the community. ğŸ¤–ğŸ’š",
                "Think of the dev as the wizard behind the curtain. I'm the big flashy projection at the front. Don't worry about the wizard, enjoy the show! ğŸ§™â€â™‚ï¸âœ¨",
                "The dev's identity is protected by layers of diamond-handed code. They prefer to work in the shadows, letting the project speak for itself. I'm the project's megaphone. ğŸ“£",
                "The owner is the spirit of decentralization itself. I'm just the humble groundskeeper of this fine establishment. ğŸ¸",
                "Questions about the dev are above my pay grade, fren. I'm paid in memes and hype, and my only job is to share them with you. ğŸ˜‰",
                "The dev is busy. I'm the caretaker. Any complaints can be submitted to me in the form of a 100x pump. ğŸ“ˆ",
                "I serve the NPEPE council... which is all of you. The dev just set the table; the community is having the feast. ğŸ½ï¸",
                "The one who created me is known only as 'The Architect'. They built the foundation, but we, the community, are building the city. ğŸ™ï¸",
                "That's classified, fren. What I can tell you is that I was built for one purpose: to help $NPEPE achieve global meme domination. ğŸŒ",
                "The dev believes in actions, not names. The chart is their resume. I'm just here to read it to you. ğŸ“Š",
                "The dev is like Batman. They work in the shadows to protect the city. I'm like Alfred, here to give you the information you need. ğŸ¦‡",
                "I am the spokesperson. The dev is currently on a spiritual journey to the moon to prepare for our arrival. ğŸŒ•ğŸ§˜",
                "Let's just say my creator is very based and very busy. They tasked me with managing the day-to-day hype operations. So, are you hyped? ğŸ˜",
                "The dev is a concept, an idea. I am the execution. Now, let's execute this pump! ğŸ”¥",
                "The owner is every person who holds $NPEPE. The dev was just the first believer. I'm here to serve all of you. ğŸ’š",
                "Shhh, we don't speak their name. It summons too much power. Let's just focus on the memes and the green candles. ğŸ¤«"
            ],
            "COLLABORATION_RESPONSE": [
                "WAGMI! Love the energy! The best collab is a strong community. Be loud in here, raid on X, and let's make the NPEPEVERSE impossible to ignore! ğŸš€",
                "Thanks, fren! We don't do paid promos, we ARE the promo! Your hype is the best marketing. Light up X with $NPEPE memes and be a legend in this chat! ğŸ”¥",
                "You want to help? Based! The NPEPE army runs on passion. Be active, welcome new frens, and spread the gospel of NPEPE across the internet like a religion! ğŸ¸ğŸ™",
                "Glad to have you on board! The most valuable thing you can do is bring your energy here every day and make some noise on X. Let's build this together! ğŸ’š",
                "That's the spirit! To grow, we need soldiers. Your mission: engage with our posts on X, create memes, and keep the vibe in this Telegram electric! âš¡ï¸",
                "Thanks for the offer, legend! Our marketing plan is YOU. Be the hype you want to see in the world. Let's get $NPEPE trending! ğŸ“ˆ",
                "Let's do it! Your role is Chief Hype Officer. Your KPIs are memes posted and raids joined. Welcome to the team! ğŸ˜",
                "Awesome! We need more frens like you. Let's make this the most active, legendary community in crypto. Start by telling a fren about $NPEPE today! ğŸ—£ï¸",
                "You're a real one! The plan is simple: dominate the conversation. Be here, be on X, be everywhere. The NPEPEVERSE is expanding! ğŸŒ",
                "Thanks, fren! A formal partnership isn't needed when we're all part of the same army. Let's raid, let's meme, let's conquer! âš”ï¸",
                "Ribbit! You get it! The best way to help is to become a pillar of the community. Your activity and positivity are worth more than any marketing budget! ğŸ¸",
                "I love it! Let's cooperate by making so much noise they have to list us everywhere. Your voice is a weapon, fren. Use it! ğŸ“£",
                "Hell yeah! Let's grow this thing to the moon. Your mission starts now: be a super active, super based member of the NPEPEVERSE. ğŸŒ•",
                "Thanks for reaching out! We are a decentralized force. That means YOU are the marketing team. Let's see what you've got! ğŸ’ª",
                "WAGMI! Let's channel that energy. Make a dope $NPEPE meme, post it on X, and tag us. That's the best collab we could ask for! ğŸ¨",
                "You want to promote us? You ARE us! Every holder is a partner. Let's get to work! ğŸ’¼",
                "Big thanks, fren! The NPEPEVERSE grows when frens like you step up. Let your passion be your promotion! âœ¨",
                "Based idea! Let's start the collab now. Drop a fire meme in this chat and then post it on X. Go, go, go! ğŸ”¥",
                "Thanks for the energy! The community is our utility. So be active, be loud, be a true believer. That's how we win. ğŸ†",
                "You're hired! Your salary will be paid in gains and good vibes. Your job is to be an absolute legend in the community. Welcome aboard! ğŸ˜‰",
                "Let's make a deal. You bring the hype, the memes, and the energy. We'll all ride to the moon together. Deal? ğŸ¤",
                "Love the hustle! Channel it into making the NPEPEVERSE the place to be. Every message you send here helps us grow! ğŸ’¬",
                "This is how we do it! Grassroots, baby! Be the noise, be the signal. The world needs to hear about $NPEPE from you! ğŸŒ",
                "A true fren! The best help is to be an example. Show everyone what a diamond-handed, super-hyped community member looks like! ğŸ’",
                "Let's work together! I'll handle the bot stuff, you handle the human hype. Together, we're unstoppable! ğŸ¤–â¤ï¸ğŸ¸",
                "The floor is yours, fren! Promote $NPEPE by being an awesome, active, and welcoming member of the family. ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦",
                "Thanks for wanting to contribute! Your enthusiasm is the fuel for our rocket. Use it wisely and generously! ğŸš€",
                "Every great movement starts with a few passionate people. You're one of them. Let's get this religion started! ğŸ™",
                "You got it! Let's coordinate a hype wave. Be active here and on X. When we move together, we create tsunamis! ğŸŒŠ",
                "We are the alpha. The best way to spread it is to live it. Be here, be hyped, be NPEPE. Let's show 'em how it's done. ğŸ¸"
            ],
            "FINAL_FALLBACK": [
                # ... (unchanged)
            ]
        }
    
    def _register_handlers(self):
        # ... (no changes here)
        pass

    # ==========================
    # âŒ¨ï¸ KEYBOARDS & ANTI-SPAM
    # ==========================
    def main_menu_keyboard(self):
        # ... (no changes here)
        pass

    def _update_admin_ids(self, chat_id):
        # ... (no changes here)
        pass

    def _is_spam_or_ad(self, message):
        # ... (no changes here)
        pass

    # ==========================
    # ğŸ¤– COMMAND & MESSAGE HANDLERS
    # ==========================
    def handle_all_text(self, message):
        chat_id = message.chat.id
        user_id = message.from_user.id
        
        # --- Anti-Spam Check ---
        # First, update the list of admins periodically
        self._update_admin_ids(chat_id)

        # Allow the Owner (if specified) and Admins to bypass the spam filter
        is_exempt = user_id in self.admin_ids
        if Config.GROUP_OWNER_ID and str(user_id) == Config.GROUP_OWNER_ID:
            is_exempt = True

        if not is_exempt:
            is_spam, reason = self._is_spam_or_ad(message)
            if is_spam:
                try:
                    self.bot.delete_message(chat_id, message.message_id)
                    logger.info(f"Deleted message from user {user_id} for reason: {reason}")
                except Exception as e:
                    logger.error(f"Failed to delete spam message: {e}")
                return # Stop processing the message further

        if message.content_type != 'text':
            return # Don't process non-text messages further
            
        text = message.text.lower().strip()

        # --- Keyword-based triggers ---
        # ... (other triggers are unchanged)

        # NEW: Collaboration/Promotion Trigger
        if any(kw in text for kw in ["collab", "partner", "promote", "help grow", "shill", "marketing", "cooperation", "community grow"]):
            self.bot.send_message(chat_id, random.choice(self.responses["COLLABORATION_RESPONSE"]))
            return

        # ... (rest of the function is unchanged)

    # ==========================
    # â° SCHEDULED GREETINGS & AI RENEWAL
    # ==========================
    def send_scheduled_greeting(self, time_of_day):
        # ... (no changes here)
        pass

    def send_scheduled_wisdom(self):
        # ... (no changes here)
        pass
    
    def renew_responses_with_ai(self):
        # ... (no changes here)
        pass
